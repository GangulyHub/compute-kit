<!doctype html>
<html>
  <head>
    <title>Worker Test</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
      }
      #output {
        padding: 10px;
        background: #f0f0f0;
        margin-top: 20px;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>Worker Test</h1>

    <button onclick="testStandaloneWorker()">Test Standalone Worker</button>
    <button onclick="testBlobWorker()">Test Blob Worker</button>

    <div id="output">Click a button to test...</div>

    <script>
      const output = document.getElementById('output');

      function log(msg) {
        console.log(msg);
        output.textContent += '\n' + msg;
      }

      async function testStandaloneWorker() {
        output.textContent = 'Testing standalone worker...';

        try {
          const worker = new Worker('/test-worker.js');

          worker.onmessage = (e) => {
            log('Worker message: ' + JSON.stringify(e.data));
          };

          worker.onerror = (e) => {
            log('Worker error: ' + e.message);
          };

          // Wait for ready
          await new Promise((resolve) => setTimeout(resolve, 100));

          log('Sending execute message...');
          worker.postMessage({
            id: 'test-1',
            type: 'execute',
            payload: { functionName: 'double', input: 21 },
            timestamp: Date.now(),
          });
        } catch (err) {
          log('Error: ' + err.message);
        }
      }

      async function testBlobWorker() {
        output.textContent = 'Testing blob worker...';

        try {
          // Simulate exactly what ComputeKit does
          const functionsCode = `"double": (n) => n * 2`;

          const workerCode = `
          console.log('[Worker] Starting...');
          const functions = {
            ${functionsCode}
          };
          console.log('[Worker] Functions:', Object.keys(functions));
          
          self.onmessage = async function(e) {
            console.log('[Worker] Got message:', e.data);
            const { id, type, payload } = e.data;
            
            if (type === 'execute') {
              const { functionName, input } = payload;
              console.log('[Worker] Executing', functionName, 'with', input);
              const fn = functions[functionName];
              
              if (!fn) {
                self.postMessage({ id, type: 'error', payload: { message: 'Function not found' } });
                return;
              }
              
              try {
                const result = await fn(input);
                console.log('[Worker] Result:', result);
                self.postMessage({ id, type: 'result', payload: { data: result } });
              } catch (err) {
                self.postMessage({ id, type: 'error', payload: { message: err.message } });
              }
            }
          };
          
          self.postMessage({ type: 'ready' });
          console.log('[Worker] Ready');
        `;

          log('Creating blob...');
          const blob = new Blob([workerCode], { type: 'application/javascript' });
          const url = URL.createObjectURL(blob);

          log('Creating worker from blob URL...');
          const worker = new Worker(url);

          worker.onmessage = (e) => {
            log('Worker message: ' + JSON.stringify(e.data));
          };

          worker.onerror = (e) => {
            log('Worker error: ' + e.message);
          };

          // Wait for ready
          await new Promise((resolve) => setTimeout(resolve, 100));

          log('Sending execute message...');
          worker.postMessage({
            id: 'test-1',
            type: 'execute',
            payload: { functionName: 'double', input: 21 },
            timestamp: Date.now(),
          });
        } catch (err) {
          log('Error: ' + err.message);
        }
      }

      // Auto-run tests
      window.onload = async () => {
        output.textContent = 'Auto-running tests...';
        await testStandaloneWorker();
        await new Promise((r) => setTimeout(r, 500));
        await testBlobWorker();
      };
    </script>
  </body>
</html>
