<!doctype html>
<html>
  <head>
    <title>Minimal Worker Test</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
        background: #1a1a2e;
        color: #0f0;
      }
      #log {
        white-space: pre-wrap;
      }
      .success {
        color: #0f0;
        font-weight: bold;
      }
      .error {
        color: #f00;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Minimal Worker Test</h1>
    <div id="log"></div>
    <script>
      const logDiv = document.getElementById('log');
      function log(msg, className = '') {
        console.log(msg);
        const line = document.createElement('div');
        line.textContent = msg;
        if (className) line.className = className;
        logDiv.appendChild(line);
      }

      async function runTest() {
        log('=== Starting minimal worker test ===');
        log('');

        const functionsCode = '"double": (n) => n * 2';

        log('Functions code: ' + functionsCode);
        log('');

        const workerCode = `
console.log('[Worker] Starting...');

const functions = {
  ${functionsCode}
};

console.log('[Worker] Functions loaded:', Object.keys(functions));

self.onmessage = async function(e) {
  console.log('[Worker] Received message:', e.data);
  const { id, type, payload } = e.data;

  if (type === 'execute') {
    const { functionName, input } = payload;
    console.log('[Worker] Executing:', functionName, 'with input:', input);
    const fn = functions[functionName];

    if (!fn) {
      console.log('[Worker] Function not found!');
      self.postMessage({
        id,
        type: 'error',
        payload: { message: 'Function not found: ' + functionName }
      });
      return;
    }

    try {
      console.log('[Worker] Calling function...');
      const result = fn(input);
      console.log('[Worker] Result:', result);
      
      self.postMessage({
        id,
        type: 'result',
        payload: { data: result }
      });
      console.log('[Worker] Result sent');
    } catch (err) {
      console.error('[Worker] Error:', err);
      self.postMessage({
        id,
        type: 'error',
        payload: { message: err.message }
      });
    }
  }
};

console.log('[Worker] Ready, sending ready message');
self.postMessage({ type: 'ready' });
`;

        log('Creating blob and worker...');

        const blob = new Blob([workerCode], { type: 'application/javascript' });
        const url = URL.createObjectURL(blob);
        log('Blob URL: ' + url);

        const worker = new Worker(url);
        log('Worker created');

        let resultReceived = false;

        worker.onmessage = (e) => {
          log('Main: Received: ' + JSON.stringify(e.data));
          if (e.data.type === 'result') {
            resultReceived = true;
            log('SUCCESS! double(21) = ' + e.data.payload.data, 'success');
          } else if (e.data.type === 'error') {
            log('ERROR: ' + e.data.payload.message, 'error');
          } else if (e.data.type === 'ready') {
            log('Worker is ready!');
          }
        };

        worker.onerror = (e) => {
          log('WORKER ERROR: ' + e.message + ' at line ' + e.lineno, 'error');
          log('Filename: ' + e.filename, 'error');
        };

        await new Promise((r) => setTimeout(r, 200));

        log('Sending execute message...');
        worker.postMessage({
          id: 'test-123',
          type: 'execute',
          payload: { functionName: 'double', input: 21 },
        });

        await new Promise((r) => setTimeout(r, 1000));

        if (!resultReceived) {
          log('TIMEOUT: No result received after 1 second', 'error');
        }

        log('');
        log('=== Test complete ===');

        worker.terminate();
        URL.revokeObjectURL(url);
      }

      runTest();
    </script>
  </body>
</html>
